# 小铁皮 - 桌面宠物

一个像素风格桌面宠物，具有完整的养成系统、成长系统、道具系统、情绪系统和学术论文阅读助手功能。

---

## 目录

1. [快速开始](#1-快速开始)
2. [基础数值系统](#2-基础数值系统)
3. [成长与经验系统](#3-成长与经验系统)
4. [道具与背包系统](#4-道具与背包系统)
5. [亲密度系统](#5-亲密度系统)
6. [情绪系统](#6-情绪系统)
7. [睡眠与梦境系统](#7-睡眠与梦境系统)
8. [日常闲聊系统](#8-日常闲聊系统)
9. [学术日报系统](#9-学术日报系统)
10. [视觉系统](#10-视觉系统)
11. [交互系统](#11-交互系统)
12. [数据存储](#12-数据存储)
13. [文件结构](#13-文件结构)
14. [开发与打包](#14-开发与打包)

---

## 1. 快速开始

### 运行源码
```bash
cd /Users/shuyun/Documents/tools/xiaotiepi
python pet.py
```

### 打包为 macOS App
```bash
pyinstaller 小铁皮.spec
# 输出: dist/小铁皮.app
```

### 安装到 Applications
```bash
cp -R dist/小铁皮.app /Applications/
```

---

## 2. 基础数值系统

### 2.1 四项核心数值

| 数值 | 范围 | 初始值 | 衰减速率(每小时) | 说明 |
|------|------|--------|-----------------|------|
| 饥饿值 (hunger) | 0-100 | 80 | -5 | 需要喂食维持 |
| 清洁度 (cleanliness) | 0-100 | 80 | -3 | 需要洗澡维持 |
| 心情值 (happiness) | 0-100 | 80 | -2 | 需要玩耍和互动维持 |
| 活力值 (vitality) | 0-100 | 50 | -1 | 影响宠物颜色深浅 |

### 2.2 数值恢复与经验获取

| 操作 | 恢复量 | 活力增益 | 经验值 |
|------|--------|---------|--------|
| 喂食 | 饥饿 +30 | +3 | +10 |
| 洗澡 | 清洁 +40 | +3 | +8 |
| 玩耍 | 心情 +25 | +4 | +12 |
| 点击 | - | +0.5 | +1 |
| 安慰 | 心情 +15 | +2 | +5 |
| 闲聊 | - | +1 | +15 |

### 2.3 状态判定

| 状态 | 条件 | 优先级 |
|------|------|--------|
| dead | is_dead = true | 1 (最高) |
| sick | 任一数值 ≤ 0 | 2 |
| sleep | 时间 23:00-6:00 | 3 |
| angry/annoyed | 情绪系统生气等级 ≥ 1 | 4 |
| hungry | 饥饿 < 30 | 5 |
| dirty | 清洁 < 30 | 6 |
| sad | 心情 < 30 | 7 |
| lonely | 超过寂寞阈值未互动 | 8 |
| happy | 三项数值均 > 70 | 9 |
| idle | 默认状态 | 10 (最低) |

---

## 3. 成长与经验系统

### 3.1 等级阶段

| 等级范围 | 阶段 | 称号 | 颜色 |
|---------|------|------|------|
| 1-9 | 萌新期 | 小萌新 | #4ADE80 (绿) |
| 10-24 | 成长期 | 学徒 | #60A5FA (蓝) |
| 25-49 | 成熟期 | 伙伴 | #A855F7 (紫) |
| 50+ | 传说期 | 传说 | #F59E0B (金) |

### 3.2 经验值计算

- **升级所需经验**: `100 + (level - 1) * 50`
- **Lv.1 → Lv.2**: 100 EXP
- **Lv.10 → Lv.11**: 550 EXP

### 3.3 行为统计

系统会记录以下行为用于解锁道具：
- 喂食/洗澡/玩耍次数
- 点击/安慰/闲聊次数
- 论文阅读/点赞/收藏次数
- 连续照顾天数
- 存活天数

---

## 4. 道具与背包系统

### 4.1 道具槽位

| 槽位 | 说明 |
|------|------|
| HEAD | 头部装饰（帽子、蝴蝶结等） |
| FACE | 脸部装饰（眼镜） |
| NECK | 脖子装饰（围巾） |
| HAND | 手持物品 |
| EFFECT | 特效（粒子效果） |

### 4.2 道具列表

#### 头部道具
| 道具 | 稀有度 | 解锁条件 |
|------|--------|----------|
| 冒险小帽 | 普通 | 默认拥有 |
| 蝴蝶结 | 普通 | 默认拥有 |
| 睡帽 | 普通 | 默认拥有 |
| 小花 | 优秀 | Lv.10 |
| 小皇冠 | 传说 | Lv.50 |

#### 脸部道具
| 道具 | 稀有度 | 解锁条件 |
|------|--------|----------|
| 圆框眼镜 | 普通 | 默认拥有 |
| 学者眼镜 | 稀有 | 论文阅读 50次 |

#### 脖子道具
| 道具 | 稀有度 | 解锁条件 |
|------|--------|----------|
| 红围巾 | 普通 | 默认拥有 |
| 彩虹围巾 | 史诗 | 连续照顾 30天 |

#### 特效道具
| 道具 | 稀有度 | 解锁条件 |
|------|--------|----------|
| 闪闪发光 | 稀有 | 洗澡 100次 |
| 爱心环绕 | 史诗 | 亲密度 100 |

### 4.3 背包界面

右键菜单 → 🎒 背包，可以：
- 查看所有已拥有道具
- 装备/卸下道具
- 查看未解锁道具及解锁条件
- 预览装备效果

---

## 5. 亲密度系统

### 5.1 亲密度等级

| 亲密度范围 | 等级名称 | 每日闲聊次数 |
|-----------|---------|-------------|
| 0-19 | 陌生 | 1 次 |
| 20-39 | 认识 | 2 次 |
| 40-59 | 朋友 | 3 次 |
| 60-79 | 好友 | 4 次 |
| 80-99 | 挚友 | 5 次 |
| 100 | 灵魂伴侣 | 5 次 |

### 5.2 亲密度获取（每日上限）

| 途径 | 每次获得 | 每日上限 |
|------|---------|---------|
| 闲聊 | +0.5 | 2.5 |
| 喂食 | +0.25 | 0.75 |
| 清洁 | +0.25 | 0.5 |
| 论文互动 | +0.25 | 0.75 |
| 连续照顾 ≥3 天 | +1.0 | - |

### 5.3 亲密度惩罚

| 触发条件 | 惩罚 | 频率 |
|---------|------|------|
| 饥饿 < 30 | -0.5 | 每天首次 |
| 饥饿 < 15 | -2 | 每次触发 |
| 清洁 < 30 | -0.5 | 每天首次 |
| 心情 < 15 | -2 | 每次触发 |
| 当天第 2+ 次生气 | -0.5 | 每次 |
| 达到超级不爽 | -3 | 每次 |
| 超过 24 小时未互动 | -1 | 每次 |
| 死亡 | -20 | 每次 |

---

## 6. 情绪系统

### 6.1 生气等级

| 等级 | 状态名称 | 冷却时间 | 心情惩罚 |
|------|---------|---------|---------|
| 0 | 正常 | - | - |
| 1 | 轻微不满 | 10 秒 | -3 |
| 2 | 生气 | 30 秒 | -5 |
| 3 | 超级不爽 | 需道歉 | -15 |

### 6.2 触发条件

**点击触发（10分钟滑动窗口）**
- 21-35 次 → 等级 1
- 36-50 次 → 等级 2
- 51+ 次 → 等级 3

**深夜打扰（23:00-6:00）**
- 第 1 次 → 等级 1
- 第 2 次 → 等级 2
- 第 3+ 次 → 等级 3

### 6.3 和解方式

- 等级 1-2: 等待冷却自动消气
- 等级 3: 必须输入道歉语（包含"对不起"或"sorry"）

---

## 7. 睡眠与梦境系统

- **睡眠时段**: 23:00 - 6:00
- **好梦条件**: 睡前心情 ≥ 70
- **噩梦条件**: 睡前心情 ≤ 30
- **深夜打扰**: 会触发生气

---

## 8. 日常闲聊系统

### 8.1 触发方式

1. **主动发起**: 右键菜单 → 💬 聊聊天
2. **宠物邀请**: 随机弹出橙色边框气泡，点击进入

### 8.2 聊天窗口特点

- 像素 RPG 风格界面
- 打字机效果
- 历史记录保存
- 基于 Claude API 的智能对话

---

## 9. 学术日报系统

### 9.1 论文抓取

- **来源**: arXiv (https), bioRxiv
- **分类**: q-bio.BM, q-bio.QM, cs.LG, stat.ML
- **频率**: 每天自动抓取一次
- **筛选**: 基于关键词和用户口味演化

### 9.2 论文功能

| 功能 | 说明 |
|------|------|
| AI 摘要 | Claude 生成中文摘要和点评 |
| 兴趣评分 | 1-5 分自动评分 |
| 精读推荐 | 高分论文标记 deep_read |
| 点赞/收藏 | 影响口味演化 |
| 深入讨论 | 可以和小铁皮讨论论文内容 |

### 9.3 触发方式

- 右键菜单 → 📰 今日论文
- 点击论文提醒气泡

---

## 10. 视觉系统

### 10.1 基础像素图

- **尺寸**: 10×9 像素
- **像素大小**: 7px（可调整）
- **特征**: 小耳朵，暖珊瑚色调

### 10.2 等级显示

- 头顶像素风格显示 "Lv.X"
- 使用 3x5 像素字体渲染

### 10.3 体型系统

根据饥饿历史（168 小时滚动窗口）:
- **偏瘦**: 平均饥饿值 < 40
- **正常**: 平均饥饿值 40-75
- **偏胖**: 平均饥饿值 > 75

### 10.4 动画效果

| 动画 | 触发条件 |
|------|---------|
| 眨眼 | 随机（2-5秒间隔） |
| 呼吸弹跳 | 常态 |
| 走路 | 随机触发或手动开启 |
| 跳跃 | 点击、开心事件 |
| 晕倒 | 被剧烈摇晃 |
| Zzz | 睡眠状态 |

### 10.5 道具渲染

- 装备的道具会渲染在宠物身上
- 睡眠/晕倒/生病/死亡状态隐藏道具
- 支持体型偏移补偿

---

## 11. 交互系统

### 11.1 鼠标交互

| 操作 | 效果 |
|------|------|
| 左键点击 | 互动、触发对话 |
| 左键拖拽 | 移动宠物位置 |
| 剧烈摇晃 | 触发晕倒/生气 |
| 右键/Ctrl+左键 | 打开菜单 |

### 11.2 右键菜单

| 菜单项 | 功能 |
|--------|------|
| 🍙 喂食 | 恢复饥饿值，+10 EXP |
| 🛁 洗澡 | 恢复清洁度，+8 EXP |
| 🎮 玩耍 | 恢复心情值，+12 EXP |
| 📊 状态查看 | 查看详细状态 |
| 💬 聊聊天 | 打开闲聊窗口 |
| 📰 今日论文 | 查看学术日报 |
| 🎒 背包 | 打开道具背包 |
| 🫂 安慰一下 | 安慰宠物 |
| 🚶 走一走 | 开启/关闭走动模式 |
| 📏 大小 | 调整宠物大小 |
| 🔑 设置 API Key | 配置 Anthropic API |
| 💀 复活 | 复活死亡的宠物 |
| ❌ 拜拜 | 退出程序 |

---

## 12. 数据存储

### 12.1 存储位置

```
~/.xiaotiepi/
├── xiaotiepi_save.json       # 主存档（数值、成长、道具、行为统计）
├── api_key.json              # Anthropic API Key
├── my_dialogues.txt          # 自定义台词
├── casual_chat_history.json  # 闲聊历史
├── chat_history.json         # 论文聊天历史
├── paper_data.json           # 当日论文数据
├── taste_profile.json        # 论文口味配置
├── bookmarks.json            # 论文收藏
├── notes/                    # 论文笔记
└── debug.log                 # 调试日志
```

### 12.2 存档数据结构

```python
{
    # 基础数值
    'hunger': 80,
    'cleanliness': 80,
    'happiness': 80,
    'vitality': 50,
    'trust': 0,

    # 成长数据
    'growth_data': {
        'total_exp': 0,
        'level': 1,
    },

    # 行为统计
    'behavior_stats': {
        'feed_count': 0,
        'clean_count': 0,
        'play_count': 0,
        'pet_count': 0,
        'comfort_count': 0,
        'paper_reads': 0,
        'chat_count': 0,
        'consecutive_care': 0,
        'consecutive_care_max': 0,
        # ...
    },

    # 道具背包
    'inventory': {
        'owned_items': ['hat_adventure', 'hat_bow', ...],
        'equipped': {
            'head': None,
            'face': None,
            'neck': None,
            'hand': None,
            'effect': None
        },
    },
}
```

---

## 13. 文件结构

```
xiaotiepi/
├── main.py                   # 程序入口（SSL 证书设置、预导入）
├── pet.py                    # 主逻辑（90KB，动画、交互、状态机）
├── save.py                   # 数据管理（62KB，存档、数值、成长系统）
├── sprites.py                # 像素精灵图（33KB，动画帧、颜色系统）
├── items.py                  # 道具系统（15KB，道具定义、解锁条件）
├── inventory_window.py       # 背包窗口（18KB，道具 UI）
├── ui_theme.py               # 统一 UI 主题（6KB，暖色系组件）
├── bubble.py                 # 对话气泡（21KB，台词库、气泡显示）
├── casual_chat_window.py     # 闲聊窗口（16KB，AI 对话）
├── sounds.py                 # 音效管理
├── 小铁皮.spec               # PyInstaller 打包配置
├── setup.py                  # py2app 打包配置（已弃用）
├── paper_agent/              # 学术日报模块
│   ├── __init__.py
│   ├── api_key_manager.py    # API Key 管理
│   ├── chat_window.py        # 论文聊天窗口（53KB）
│   ├── config.py             # 配置（API URL、关键词、Prompt）
│   ├── fetcher.py            # 论文抓取（arXiv、bioRxiv）
│   ├── summarizer.py         # AI 摘要生成
│   └── taste.py              # 口味演化算法
└── test_*.py                 # 测试文件
```

---

## 14. 开发与打包

### 14.1 依赖

```
anthropic          # Claude API SDK
httpx              # HTTP 客户端
certifi            # SSL 证书
tkinter            # GUI（Python 内置）
```

### 14.2 运行开发版

```bash
python pet.py
```

### 14.3 打包命令

```bash
# 使用 PyInstaller（推荐）
pyinstaller 小铁皮.spec

# 输出位置
dist/小铁皮.app
```

### 14.4 已知问题

- **py2app 不兼容**: anthropic/httpx SDK 在 py2app 打包后无法正常导入，改用 PyInstaller 解决
- **arXiv API**: 必须使用 HTTPS，且 `+OR+` 不能被 URL 编码

---

## 版本信息

- **框架**: Python 3.12 + Tkinter
- **打包**: PyInstaller 6.x (macOS)
- **AI**: Anthropic Claude API (闲聊、论文摘要)
- **支持平台**: macOS (arm64/x86_64)
