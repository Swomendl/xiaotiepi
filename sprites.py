"""
sprites.py - 小铁皮的像素精灵图数据
基于 Claude 的形象设计：10x9 像素，有小耳朵的暖色调小方块

视觉升级 v2: 使用轮廓线 + 投影实现立体感（而非内部光影点）
"""

from typing import List, Dict, Tuple


def hex_to_rgb(hex_color: str) -> Tuple[int, int, int]:
    """十六进制颜色转 RGB"""
    hex_color = hex_color.lstrip('#')
    return tuple(int(hex_color[i:i+2], 16) for i in (0, 2, 4))


def rgb_to_hex(r: int, g: int, b: int) -> str:
    """RGB 转十六进制颜色"""
    return f'#{r:02X}{g:02X}{b:02X}'


def lerp_color(color1: str, color2: str, t: float) -> str:
    """在两个颜色之间插值，t 从 0 到 1"""
    r1, g1, b1 = hex_to_rgb(color1)
    r2, g2, b2 = hex_to_rgb(color2)
    r = int(r1 + (r2 - r1) * t)
    g = int(g1 + (g2 - g1) * t)
    b = int(b1 + (b2 - b1) * t)
    return rgb_to_hex(r, g, b)


# 基础调色板 - Claude 暖色调
COLORS: Dict[int, str] = {
    0: '',           # 透明
    1: '#D4856A',    # 身体 - 暖珊瑚色（基准）
    2: '#2D2D2D',    # 眼睛 - 炭黑色
    3: '#B86E55',    # 深色 - 闭眼/阴影（基准）
    4: '#E8A08E',    # 浅色 - 高光
    5: '#6B8E23',    # 绿色 - 脏脏的臭味
    6: '#87CEEB',    # 蓝色 - 汗水/眼泪
    7: '#808080',    # 灰色 - 死亡
    8: '#FF6B6B',    # 红色 - 生气
    # 轮廓线颜色（渲染时自动添加，不在精灵数据中使用）
    99: '#8B5A4A',   # 轮廓线 - 深棕色，比身体色深
}

# 投影颜色（半透明效果通过 alpha 实现）
SHADOW_COLOR = '#00000040'  # 带透明度的黑色

# 活力值影响的颜色范围
COLOR_FADED = {
    1: '#F0D0C4',    # 很淡的珊瑚色（褪色）
    3: '#E0B8A8',    # 很淡的阴影色
    99: '#C0A090',   # 很淡的轮廓色
}
COLOR_VIBRANT = {
    1: '#A85540',    # 很深的橙色（充满活力）
    3: '#8B4030',    # 很深的阴影色
    99: '#5A3020',   # 很深的轮廓色
}


def get_dynamic_colors(vitality: float) -> Dict[int, str]:
    """
    根据活力值返回动态调色板
    vitality: 0-100
    """
    colors = COLORS.copy()
    t = max(0, min(100, vitality)) / 100.0
    
    dynamic_color_indices = [1, 3, 99]
    
    if t < 0.5:
        ratio = t / 0.5
        for idx in dynamic_color_indices:
            if idx in COLOR_FADED and idx in COLORS:
                colors[idx] = lerp_color(COLOR_FADED[idx], COLORS[idx], ratio)
    else:
        ratio = (t - 0.5) / 0.5
        for idx in dynamic_color_indices:
            if idx in COLOR_VIBRANT and idx in COLORS:
                colors[idx] = lerp_color(COLORS[idx], COLOR_VIBRANT[idx], ratio)
    
    return colors


PIXEL_SIZE = 7  # 每个像素的实际大小

# ═══════════════════════════════════════════════════════════════
#  轮廓线 & 投影生成函数
# ═══════════════════════════════════════════════════════════════

def add_outline(sprite: List[List[int]], outline_color: int = 99) -> List[List[int]]:
    """
    为精灵图自动添加轮廓线
    在所有非透明像素的外围（上下左右相邻的透明位置）添加轮廓色
    
    返回一个扩展后的精灵图（尺寸 +2 以容纳轮廓）
    """
    if not sprite or not sprite[0]:
        return sprite
    
    h = len(sprite)
    w = len(sprite[0])
    
    # 创建扩展后的画布（上下左右各 +1）
    new_h = h + 2
    new_w = w + 2
    result = [[0] * new_w for _ in range(new_h)]
    
    # 先复制原始精灵到中心位置
    for y in range(h):
        for x in range(w):
            result[y + 1][x + 1] = sprite[y][x]
    
    # 在非透明像素周围添加轮廓
    for y in range(h):
        for x in range(w):
            if sprite[y][x] != 0:  # 非透明像素
                # 检查四个方向（上下左右）
                for dy, dx in [(-1, 0), (1, 0), (0, -1), (0, 1)]:
                    ny, nx = y + 1 + dy, x + 1 + dx
                    # 如果相邻位置是透明的，画轮廓
                    if result[ny][nx] == 0:
                        result[ny][nx] = outline_color
    
    return result


def add_outline_and_shadow(sprite: List[List[int]], 
                           outline_color: int = 99,
                           shadow_offset: Tuple[int, int] = (1, 2)) -> Tuple[List[List[int]], int, int]:
    """
    为精灵图添加轮廓线和投影
    
    返回: (扩展后的精灵图, 投影X偏移, 投影Y偏移)
    投影需要在渲染时单独绘制（因为需要半透明效果）
    """
    outlined = add_outline(sprite, outline_color)
    return outlined, shadow_offset[0], shadow_offset[1]


def get_shadow_positions(sprite: List[List[int]], 
                         offset_x: int = 1, 
                         offset_y: int = 2) -> List[Tuple[int, int]]:
    """
    获取投影需要绘制的像素位置列表
    
    返回: [(x, y), ...] 相对于精灵左上角的投影像素坐标
    """
    if not sprite or not sprite[0]:
        return []
    
    h = len(sprite)
    w = len(sprite[0])
    shadow_positions = []
    
    for y in range(h):
        for x in range(w):
            if sprite[y][x] != 0:  # 非透明像素
                shadow_x = x + offset_x
                shadow_y = y + offset_y
                shadow_positions.append((shadow_x, shadow_y))
    
    return shadow_positions


# ═══════════════════════════════════════════════════════════════
#  精灵图定义 (10 wide × 9 tall)
#  0 = 透明, 1 = 身体, 2 = 眼睛, 3 = 深色
#  【已恢复原始配色，去掉了内部光影点】
# ═══════════════════════════════════════════════════════════════

# 正常状态
SPRITE_IDLE: List[List[int]] = [
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 2, 2, 1, 1, 2, 2, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
]

# 眨眼
SPRITE_BLINK: List[List[int]] = [
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 3, 3, 1, 1, 3, 3, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
]

# 开心 - 眯眼笑
SPRITE_HAPPY: List[List[int]] = [
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 3, 3, 1, 1, 3, 3, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 4, 4, 4, 4, 1, 1, 1],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
]

# 走路 A - 腿分开
SPRITE_WALK_A: List[List[int]] = [
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 2, 2, 1, 1, 2, 2, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 0, 0, 0, 0, 0, 0, 1, 1],
    [1, 1, 0, 0, 0, 0, 0, 0, 1, 1],
]

# 走路 B - 腿并拢
SPRITE_WALK_B: List[List[int]] = [
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 2, 2, 1, 1, 2, 2, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [0, 0, 1, 1, 0, 0, 1, 1, 0, 0],
    [0, 0, 1, 1, 0, 0, 1, 1, 0, 0],
]

# 饥饿 - 大眼睛
SPRITE_HUNGRY: List[List[int]] = [
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 2, 2, 1, 1, 2, 2, 1, 1],
    [1, 1, 2, 2, 1, 1, 2, 2, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 3, 3, 1, 1, 1, 1],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
]

# 脏脏 - 有臭味符号
SPRITE_DIRTY: List[List[int]] = [
    [0, 1, 1, 0, 5, 0, 0, 1, 1, 5],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 2, 2, 1, 1, 2, 2, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [5, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 0, 5, 0, 5, 1, 1, 0],
]

# 不开心/伤心 - 流泪
SPRITE_SAD: List[List[int]] = [
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 2, 2, 1, 1, 2, 2, 1, 1],
    [1, 1, 1, 6, 1, 1, 1, 6, 1, 1],
    [1, 1, 1, 1, 3, 3, 1, 1, 1, 1],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
]

# 生病 - 颜色变暗，冒冷汗
SPRITE_SICK: List[List[int]] = [
    [0, 3, 3, 0, 0, 6, 0, 3, 3, 0],
    [0, 3, 3, 3, 3, 3, 3, 3, 3, 0],
    [3, 3, 3, 3, 3, 3, 3, 3, 3, 3],
    [3, 3, 3, 3, 3, 3, 3, 3, 3, 3],
    [3, 3, 2, 2, 3, 3, 2, 2, 3, 3],
    [3, 3, 3, 3, 3, 3, 3, 3, 3, 3],
    [3, 3, 3, 3, 3, 3, 3, 3, 3, 3],
    [0, 3, 3, 0, 0, 0, 0, 3, 3, 0],
    [0, 3, 3, 0, 0, 0, 0, 3, 3, 0],
]

# 睡觉 - 蜷成一团 + 睡帽
SPRITE_SLEEP: List[List[int]] = [
    [0, 0, 0, 0, 0, 3, 3, 1, 0, 0],
    [0, 0, 0, 0, 3, 1, 1, 1, 3, 0],
    [0, 0, 0, 1, 1, 1, 1, 1, 1, 0],
    [0, 0, 1, 1, 1, 1, 1, 1, 1, 1],
    [0, 0, 1, 1, 3, 3, 1, 1, 1, 1],
    [0, 0, 1, 1, 1, 1, 1, 1, 1, 1],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 0, 0],
    [0, 0, 1, 1, 1, 1, 1, 0, 0, 0],
]

# 生气 - 皱眉 + 眼睛竖起来
SPRITE_ANGRY: List[List[int]] = [
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 3, 1, 1, 1, 1, 3, 1, 1],
    [1, 1, 1, 2, 1, 1, 2, 1, 1, 1],
    [1, 1, 1, 2, 1, 1, 2, 1, 1, 1],
    [1, 1, 1, 3, 3, 3, 3, 1, 1, 1],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
]

# 死亡 - 变灰 + X眼
SPRITE_DEAD: List[List[int]] = [
    [0, 7, 7, 0, 0, 0, 0, 7, 7, 0],
    [0, 7, 7, 7, 7, 7, 7, 7, 7, 0],
    [7, 7, 7, 7, 7, 7, 7, 7, 7, 7],
    [7, 7, 7, 7, 7, 7, 7, 7, 7, 7],
    [7, 2, 7, 2, 7, 7, 2, 7, 2, 7],
    [7, 7, 2, 7, 7, 7, 7, 2, 7, 7],
    [7, 7, 7, 7, 7, 7, 7, 7, 7, 7],
    [0, 7, 7, 0, 0, 0, 0, 7, 7, 0],
    [0, 7, 7, 0, 0, 0, 0, 7, 7, 0],
]

# 寂寞 - 耳朵耷拉
SPRITE_LONELY: List[List[int]] = [
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 2, 2, 1, 1, 2, 2, 1, 1],
    [1, 1, 1, 1, 3, 3, 1, 1, 1, 1],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
]

# 晕倒 - 躺平
SPRITE_DIZZY: List[List[int]] = [
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 1, 1, 0, 0, 0, 0, 0, 0, 0],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 3, 1, 3, 1, 1, 3, 1, 3, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [0, 0, 0, 0, 0, 0, 0, 1, 1, 0],
]

# 打哈欠
SPRITE_YAWN: List[List[int]] = [
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 3, 3, 1, 1, 3, 3, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 2, 2, 2, 2, 1, 1, 1],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
]

# 坐下
SPRITE_SIT: List[List[int]] = [
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 2, 2, 1, 1, 2, 2, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [0, 0, 1, 1, 0, 0, 1, 1, 0, 0],
]

# 跑步 A
SPRITE_RUN_A: List[List[int]] = [
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 2, 2, 1, 1, 2, 2, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [0, 1, 0, 0, 0, 0, 0, 0, 1, 0],
    [1, 0, 0, 0, 0, 0, 0, 0, 0, 1],
]

# 跑步 B
SPRITE_RUN_B: List[List[int]] = [
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 2, 2, 1, 1, 2, 2, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [0, 0, 1, 1, 0, 0, 1, 1, 0, 0],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
]

# 跳跃
SPRITE_HOP: List[List[int]] = [
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 3, 3, 1, 1, 3, 3, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [0, 0, 0, 1, 1, 1, 1, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
]

# 向左看
SPRITE_LOOK_LEFT: List[List[int]] = [
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 2, 2, 1, 1, 2, 2, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
]

# 向右看
SPRITE_LOOK_RIGHT: List[List[int]] = [
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 2, 2, 1, 1, 2, 2, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
]

# 向上看
SPRITE_LOOK_UP: List[List[int]] = [
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 2, 2, 1, 1, 2, 2, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
]

# ═══════════════════════════════════════════════════════════════
#  拖拽精灵图（保留！笨笨的很可爱）
# ═══════════════════════════════════════════════════════════════

# 被拖拽 - 身体拉长，耳朵聚拢，脚悬空
SPRITE_DRAGGING: List[List[int]] = [
    [0, 0, 1, 1, 0, 0, 1, 1, 0, 0],  # 耳朵向内聚拢
    [0, 0, 1, 1, 1, 1, 1, 1, 0, 0],  # 头部变窄
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [0, 1, 1, 2, 1, 1, 2, 1, 1, 0],  # 眼睛（惊讶）
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [0, 0, 1, 1, 1, 1, 1, 1, 0, 0],  # 身体收窄
    [0, 0, 0, 1, 0, 0, 1, 0, 0, 0],  # 脚悬空、内收
]

# ═══════════════════════════════════════════════════════════════
#  体型变体生成
# ═══════════════════════════════════════════════════════════════

def _make_fat(sprite: List[List[int]]) -> List[List[int]]:
    """生成胖版精灵（左右各扩展1列）"""
    result = []
    for row in sprite:
        new_row = [row[0]] + list(row) + [row[-1]]
        result.append(new_row)
    return result


def _make_thin(sprite: List[List[int]]) -> List[List[int]]:
    """生成瘦版精灵（左右各收缩1列，但保持最小宽度）"""
    result = []
    for row in sprite:
        if len(row) > 6:
            new_row = row[1:-1]
        else:
            new_row = list(row)
        result.append(new_row)
    return result


# ═══════════════════════════════════════════════════════════════
#  精灵字典
# ═══════════════════════════════════════════════════════════════

_BASE_SPRITES = {
    'idle': [SPRITE_IDLE],
    'blink': [SPRITE_BLINK],
    'happy': [SPRITE_HAPPY],
    'walk': [SPRITE_WALK_A, SPRITE_WALK_B],
    'run': [SPRITE_RUN_A, SPRITE_RUN_B],
    'hop': [SPRITE_HOP],
    'hungry': [SPRITE_HUNGRY],
    'dirty': [SPRITE_DIRTY],
    'sad': [SPRITE_SAD],
    'sick': [SPRITE_SICK],
    'sleep': [SPRITE_SLEEP],
    'angry': [SPRITE_ANGRY],
    'dead': [SPRITE_DEAD],
    'lonely': [SPRITE_LONELY],
    'dizzy': [SPRITE_DIZZY],
    'yawn': [SPRITE_YAWN],
    'sit': [SPRITE_SIT],
    'look_left': [SPRITE_LOOK_LEFT],
    'look_right': [SPRITE_LOOK_RIGHT],
    'look_up': [SPRITE_LOOK_UP],
    'dragging': [SPRITE_DRAGGING],
}

SPRITES = {
    'normal': {},
    'fat': {},
    'thin': {},
}

for state, frames in _BASE_SPRITES.items():
    SPRITES['normal'][state] = frames
    SPRITES['fat'][state] = [_make_fat(f) for f in frames]
    SPRITES['thin'][state] = [_make_thin(f) for f in frames]


# ═══════════════════════════════════════════════════════════════
#  季节配件
# ═══════════════════════════════════════════════════════════════

SEASON_COLORS = {
    9: '#E74C3C',    # 红色 - 围巾
    10: '#FFB7C5',   # 春 - 粉色花瓣
    11: '#5DADE2',   # 青色 - 冰饮
    12: '#8B4513',   # 棕色 - 贝雷帽
    13: '#FF6347',   # 秋 - 红叶
    14: '#FFFFFF',   # 冬 - 白雪/冰块
    # 动画道具颜色
    23: '#FFD700',   # 金色 - 星星
    24: '#FF69B4',   # 粉色 - 爱心
    25: '#87CEEB',   # 天蓝 - 彩虹蓝
    26: '#98FB98',   # 浅绿 - 彩虹绿
    27: '#4A4A4A',   # 深灰 - 噩梦内部
    28: '#FFD700',   # 金黄 - 闪电
    29: '#FF4500',   # 橙红 - 怒气/感叹号
    30: '#D2691E',   # 棕色 - 饼干
    31: '#8B4513',   # 深棕 - 饼干点
    32: '#9370DB',   # 紫色 - 音符
    33: '#FF69B4',   # 粉色 - 蝴蝶
}

ANIMATION_COLORS = SEASON_COLORS.copy()

# 季节配件精灵
# 冬天 - 红色围巾（绕在脖子上）
ACCESSORY_SCARF: List[List[int]] = [
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 9, 9, 9, 9, 9, 9, 9, 9, 0],
    [0, 0, 9, 9, 0, 0, 0, 0, 0, 0],
    [0, 0, 9, 9, 0, 0, 0, 0, 0, 0],
]

# 春天 - 头顶小花瓣
ACCESSORY_FLOWER: List[List[int]] = [
    [0, 0, 0, 10, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
]

# 夏天 - 手拿冰饮
ACCESSORY_DRINK: List[List[int]] = [
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 11],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 11],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 14],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 11],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 11],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
]

# 秋天 - 贝雷帽
ACCESSORY_BERET: List[List[int]] = [
    [0, 0, 12, 12, 12, 12, 12, 0, 0, 0],
    [0, 12, 12, 12, 12, 12, 12, 12, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
]

# 季节配件映射
SEASON_ACCESSORIES = {
    'winter': ACCESSORY_SCARF,
    'spring': ACCESSORY_FLOWER,
    'summer': ACCESSORY_DRINK,
    'autumn': ACCESSORY_BERET,
}


# ═══════════════════════════════════════════════════════════════
#  动画道具像素图
# ═══════════════════════════════════════════════════════════════

# 喷头 (6 wide x 3 tall)
SPRITE_SHOWER_HEAD: List[List[int]] = [
    [0,  15, 15, 15, 15, 0 ],
    [15, 16, 16, 16, 16, 15],
    [0,  16,  0, 16,  0, 16],
]

# 饭团 (5 wide x 5 tall)
SPRITE_ONIGIRI: List[List[int]] = [
    [0,  0, 18,  0,  0],
    [0, 18, 18, 18,  0],
    [18, 18, 18, 18, 18],
    [19, 19, 19, 19, 19],
    [0, 18, 18, 18,  0],
]

# PS4 手柄 (7 wide x 4 tall)
SPRITE_PS4_CONTROLLER: List[List[int]] = [
    [20,  0,  0,  0,  0,  0, 20],
    [20, 20, 21, 21, 21, 20, 20],
    [0,  20, 20, 20, 20, 20,  0],
    [0,   0, 20, 20, 20,  0,  0],
]

# 动画相关颜色（补充到ANIMATION_COLORS）
ANIMATION_COLORS.update({
    15: '#A0A0A0',  # 金属灰 - 喷头主体
    16: '#606060',  # 深灰 - 喷孔
    17: '#87CEEB',  # 浅蓝 - 水滴
    18: '#FFFFFF',  # 白色 - 米饭
    19: '#1A1A1A',  # 黑色 - 海苔
    20: '#2D2D2D',  # 深灰 - 手柄主体
    21: '#4A4A4A',  # 浅灰 - 按钮区
    22: '#4169E1',  # 蓝色 - 手柄灯条
})

# 道具颜色
ITEM_COLORS = {
    # 冒险帽（绿色系）
    40: '#4A7C4E',  # 森林绿 - 帽身
    41: '#6B9E6F',  # 浅绿 - 帽子高光
    42: '#3D5940',  # 深绿 - 帽子阴影

    # 蝴蝶结（粉色系）
    43: '#FF69B4',  # 粉色 - 主色
    44: '#FF8DC7',  # 浅粉 - 高光
    45: '#DB4B8A',  # 深粉 - 阴影

    # 睡帽（蓝色系）
    46: '#4169E1',  # 皇家蓝 - 主色
    47: '#87CEEB',  # 天蓝 - 条纹
    48: '#2D4A8B',  # 深蓝 - 阴影

    # 眼镜
    49: '#2D2D2D',  # 黑色框
    50: '#4A4A4A',  # 灰色框

    # 围巾（红色系）
    51: '#DC2626',  # 红色 - 主色
    52: '#EF4444',  # 浅红 - 高光
    53: '#B91C1C',  # 深红 - 阴影

    # 皇冠（金色系）
    54: '#F59E0B',  # 金色 - 主色
    55: '#FCD34D',  # 浅金 - 高光
    56: '#D97706',  # 深金 - 阴影
    57: '#EF4444',  # 红宝石
    58: '#3B82F6',  # 蓝宝石
}


# ═══════════════════════════════════════════════════════════════
#  梦境系统
# ═══════════════════════════════════════════════════════════════

SPRITE_DREAM_CLOUD: List[List[int]] = [
    [0, 14, 14, 14, 14, 14, 14, 0],
    [14,  4,  4,  4,  4,  4,  4, 14],
    [14,  4,  0,  0,  0,  0,  4, 14],
    [14,  4,  0,  0,  0,  0,  4, 14],
    [14,  4,  4,  4,  4,  4,  4, 14],
    [0,  0, 14, 14, 14,  0,  0,  0],
]

SPRITE_NIGHTMARE_CLOUD: List[List[int]] = [
    [0,  7,  7,  7,  7,  7,  7, 0],
    [7, 27, 27, 27, 27, 27, 27, 7],
    [7, 27,  0,  0,  0,  0, 27, 7],
    [7, 27,  0,  0,  0,  0, 27, 7],
    [7, 27, 27, 27, 27, 27, 27, 7],
    [0,  0,  7,  7,  7,  0,  0, 0],
]

DREAM_ICON_STAR: List[List[int]] = [
    [0, 23, 0],
    [23, 23, 23],
    [0, 23, 0],
]

DREAM_ICON_HEART: List[List[int]] = [
    [24, 0, 24],
    [24, 24, 24],
    [0, 24, 0],
]

DREAM_ICON_RAINBOW: List[List[int]] = [
    [29, 29, 29],
    [23, 23, 23],
    [25, 25, 25],
]

NIGHTMARE_ICON_LIGHTNING: List[List[int]] = [
    [0, 28, 28],
    [28, 28, 0],
    [0, 28, 0],
]

NIGHTMARE_ICON_SKULL: List[List[int]] = [
    [14, 14, 14],
    [2, 14, 2],
    [0, 2, 0],
]

NIGHTMARE_ICON_EXCLAIM: List[List[int]] = [
    [0, 29, 0],
    [0, 29, 0],
    [0, 29, 0],
]

DREAM_ICONS_GOOD = [DREAM_ICON_STAR, DREAM_ICON_HEART, DREAM_ICON_RAINBOW]
DREAM_ICONS_BAD = [NIGHTMARE_ICON_LIGHTNING, NIGHTMARE_ICON_SKULL, NIGHTMARE_ICON_EXCLAIM]


# ═══════════════════════════════════════════════════════════════
#  睡眠打扰精灵图
# ═══════════════════════════════════════════════════════════════

SPRITE_SLEEPY_DISTURBED: List[List[int]] = [
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 2, 2, 1, 1, 3, 3, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 3, 1, 1, 1, 1, 1],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
]

SPRITE_ANNOYED_SLEEPY: List[List[int]] = [
    [0, 1, 1, 0, 0, 0, 29, 1, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 29, 1, 0],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 3, 1, 1, 1, 1, 3, 1, 1],
    [1, 1, 1, 2, 1, 1, 2, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 3, 3, 3, 3, 1, 1, 1],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
]

SPRITE_SUPER_ANNOYED: List[List[int]] = [
    [0, 1, 1, 0, 29, 29, 0, 1, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 3, 1, 1, 1, 1, 3, 1, 1],
    [1, 3, 1, 2, 1, 1, 2, 1, 3, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 3, 3, 3, 3, 3, 3, 1, 1],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
]

SPRITE_COMFORTED: List[List[int]] = [
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [0, 1, 1, 3, 1, 1, 3, 1, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [0, 1, 1, 1, 4, 4, 1, 1, 1, 0],
    [0, 0, 1, 1, 0, 0, 1, 1, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
]


# ═══════════════════════════════════════════════════════════════
#  随机开心事件配件
# ═══════════════════════════════════════════════════════════════

SPRITE_BUTTERFLY: List[List[int]] = [
    [33, 0, 0, 0, 33],
    [33, 33, 2, 33, 33],
    [33, 0, 2, 0, 33],
    [0,  0, 2, 0,  0],
]

SPRITE_COOKIE: List[List[int]] = [
    [0, 30, 30, 0],
    [30, 31, 30, 30],
    [0, 30, 31, 0],
]

SPRITE_MUSIC_NOTE: List[List[int]] = [
    [0, 32, 32],
    [0, 32, 0],
    [0, 32, 0],
    [32, 32, 0],
    [32, 32, 0],
]

HAPPY_EVENT_SPRITES = {
    'butterfly': SPRITE_BUTTERFLY,
    'cookie': SPRITE_COOKIE,
    'music': SPRITE_MUSIC_NOTE,
}


# ═══════════════════════════════════════════════════════════════
#  阅读论文精灵图
# ═══════════════════════════════════════════════════════════════

SPRITE_READING: List[List[int]] = [
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 7, 2, 7, 7, 7, 2, 7, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
]

SPRITE_READING_LEFT: List[List[int]] = [
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 2, 7, 7, 7, 2, 7, 7, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
]

SPRITE_READING_RIGHT: List[List[int]] = [
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 7, 7, 2, 7, 7, 7, 2, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
]

SPRITE_PUSH_GLASSES_1: List[List[int]] = [
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 7, 2, 7, 7, 7, 2, 7, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
]

SPRITE_PUSH_GLASSES_2: List[List[int]] = [
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 7, 2, 7, 7, 7, 2, 7, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
    [0, 1, 1, 0, 0, 0, 0, 1, 1, 0],
]

SPRITE_PAPER: List[List[int]] = [
    [14, 14, 14, 14],
    [14,  7, 14,  7],
    [14, 14, 14, 14],
]


# ═══════════════════════════════════════════════════════════════
#  注册额外精灵
# ═══════════════════════════════════════════════════════════════

_EXTRA_SPRITES = {
    'sleepy_disturbed': [SPRITE_SLEEPY_DISTURBED],
    'annoyed_sleepy': [SPRITE_ANNOYED_SLEEPY],
    'super_annoyed': [SPRITE_SUPER_ANNOYED],
    'comforted': [SPRITE_COMFORTED],
    'reading': [SPRITE_READING, SPRITE_READING_LEFT, SPRITE_READING_RIGHT],
    'push_glasses': [SPRITE_PUSH_GLASSES_1, SPRITE_PUSH_GLASSES_2, SPRITE_READING],
}

for state, frames in _EXTRA_SPRITES.items():
    SPRITES['normal'][state] = frames
    SPRITES['fat'][state] = [_make_fat(f) for f in frames]
    SPRITES['thin'][state] = [_make_thin(f) for f in frames]


# ═══════════════════════════════════════════════════════════════
#  辅助函数
# ═══════════════════════════════════════════════════════════════

def get_current_season() -> str:
    """根据当前月份获取季节"""
    from datetime import datetime
    month = datetime.now().month
    if month in [12, 1, 2]:
        return 'winter'
    elif month in [3, 4, 5]:
        return 'spring'
    elif month in [6, 7, 8]:
        return 'summer'
    else:
        return 'autumn'


def get_season_accessory() -> List[List[int]]:
    """获取当前季节的配件"""
    season = get_current_season()
    return SEASON_ACCESSORIES.get(season, [])


def get_all_colors(vitality: float) -> Dict[int, str]:
    """获取所有颜色（包括基础色、季节配件色、动画道具色、道具色）"""
    colors = get_dynamic_colors(vitality)
    colors.update(SEASON_COLORS)
    colors.update(ANIMATION_COLORS)
    colors.update(ITEM_COLORS)
    return colors


def get_sprite_frames(state: str) -> List[List[List[int]]]:
    """获取指定状态的精灵帧列表"""
    return SPRITES.get(state, SPRITES['idle'])


def get_sprite_size() -> tuple:
    """返回精灵图的像素尺寸 (宽, 高)"""
    return (10 * PIXEL_SIZE, 9 * PIXEL_SIZE)


def get_canvas_size(body_type: str = 'normal') -> tuple:
    """获取画布尺寸（包含轮廓线空间）"""
    pad = PIXEL_SIZE * 2
    width = 12 if body_type == 'fat' else 10
    # 额外 +2 是为轮廓线预留空间
    return (width * PIXEL_SIZE + pad * 2 + PIXEL_SIZE * 2, 
            9 * PIXEL_SIZE + pad * 2 + PIXEL_SIZE * 2)


def get_sprite(body_type: str, state: str) -> List[List[List[int]]]:
    bt = body_type if body_type in SPRITES else 'normal'
    if state in SPRITES[bt]:
        return SPRITES[bt][state]
    return SPRITES[bt]['idle']